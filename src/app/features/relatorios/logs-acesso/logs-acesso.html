<div class="logs-container !p-6 !min-h-screen" style="background: var(--surface-ground)">
  <!-- Header com Toolbar do PrimeNG -->
  <div class="!mb-6">
    <div class="!flex !items-center !gap-3 !mb-4">
      <lucide-icon [img]="Shield" class="!w-8 !h-8 !text-primary-600"></lucide-icon>
      <div>
        <h1 class="!text-2xl !font-bold !m-0" style="color: var(--text-color)">Logs de Acesso</h1>
        <p class="!m-0 !mt-1" style="color: var(--text-color-secondary)">Monitoramento de acessos ao sistema</p>
      </div>
    </div>

    <p-toolbar styleClass="!rounded-lg">
      <div class="p-toolbar-group-start">
        <p-button (click)="refresh()" severity="secondary" [loading]="isLoading()" styleClass="!mr-2">
          <lucide-icon [img]="RefreshCw" class="!w-4 !h-4 !mr-2" [class.animate-spin]="isLoading()"></lucide-icon>
          Atualizar
        </p-button>
      </div>

      <div class="p-toolbar-group-end">
        <p-button (click)="exportToExcel()" severity="success" styleClass="!mr-2">
          <lucide-icon [img]="FileText" class="!w-4 !h-4 !mr-2"></lucide-icon>
          Excel
        </p-button>

        <p-button (click)="exportToPDF()" severity="help">
          <lucide-icon [img]="Download" class="!w-4 !h-4 !mr-2"></lucide-icon>
          PDF
        </p-button>
      </div>
    </p-toolbar>
  </div>

  <!-- Error Message -->
  @if (error()) {
  <div class="error-message">
    <lucide-icon [img]="Activity" class="error-icon"></lucide-icon>
    <span>{{ error() }}</span>
  </div>
  }

  <!-- PrimeNG Table -->
  <p-table #dt [value]="logs()" stripedRows [loading]="isLoading()" [paginator]="true" [rows]="pagination().limit"
    [totalRecords]="pagination().total" [first]="(pagination().page - 1) * pagination().limit"
    [rowsPerPageOptions]="[10, 25, 50, 100]" [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
    (onPage)="onTablePageChange($event)" [lazy]="true" dataKey="_id" [tableStyle]="{'min-width': '80rem'}"
    [scrollable]="true" scrollHeight="60vh" [globalFilterFields]="['email', 'method', 'path', 'ip']">

    <!-- Empty State Template -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="!text-center !p-8 !border-0">
          <div class="!flex !flex-col !items-center !justify-center !text-center !min-h-[16rem] !w-full">
            <lucide-icon [img]="Activity" class="!w-12 !h-12 !text-surface-400 !mb-4"></lucide-icon>
            <h3 class="!text-lg !font-semibold !text-surface-600 dark:!text-surface-400 !mb-2">Nenhum log encontrado
            </h3>
            <p class="!text-surface-500 dark:!text-surface-500 !max-w-md">Não foram encontrados logs de acesso com os
              filtros
              aplicados.</p>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Header -->
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="createdAt" style="width:14%">
          <div class="flex items-center gap-2">
            <lucide-icon [img]="Clock" class="w-4 h-4"></lucide-icon>
            Data/Hora
            <p-sortIcon field="createdAt"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="email" style="width:16%">
          <div class="flex items-center gap-2">
            <lucide-icon [img]="User" class="w-4 h-4"></lucide-icon>
            Usuário
            <p-sortIcon field="email"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="method" style="width:10%">
          <div class="flex items-center gap-2">
            Método
            <p-sortIcon field="method"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="path" style="width:20%">
          <div class="flex items-center gap-2">
            Endpoint
            <p-sortIcon field="path"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="statusCode" style="width:10%">
          <div class="flex items-center gap-2">
            Status
            <p-sortIcon field="statusCode"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="success" style="width:10%">
          <div class="flex items-center gap-2">
            Sucesso
            <p-sortIcon field="success"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="responseTime" style="width:10%">
          <div class="flex items-center gap-2">
            Tempo
            <p-sortIcon field="responseTime"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="ip" style="width:10%">
          <div class="flex items-center gap-2">
            IP
            <p-sortIcon field="ip"></p-sortIcon>
          </div>
        </th>
      </tr>
      <!-- Filter Row -->
      <tr>
        <th>
          <p-columnFilter type="date" field="createdAt" display="menu"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="email" placeholder="Buscar usuário"
            ariaLabel="Filter Email"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter field="method" matchMode="equals" [showMenu]="false">
            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
              <p-select [ngModel]="value" [options]="methodOptions" (onChange)="filter($event.value)"
                placeholder="Método" [showClear]="true" optionLabel="label" optionValue="value">
              </p-select>
            </ng-template>
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="path" placeholder="Buscar endpoint"
            ariaLabel="Filter Endpoint"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="numeric" field="statusCode" placeholder="Status"
            ariaLabel="Filter Status"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter field="success" matchMode="equals" [showMenu]="false">
            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
              <p-select [ngModel]="value" [options]="successOptions" (onChange)="filter($event.value)"
                placeholder="Sucesso" [showClear]="true" optionLabel="label" optionValue="value">
              </p-select>
            </ng-template>
          </p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="numeric" field="responseTime" placeholder="Tempo"
            ariaLabel="Filter Response Time"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="ip" placeholder="IP" ariaLabel="Filter IP"></p-columnFilter>
        </th>
      </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-log let-rowIndex="rowIndex">
      <tr class="!hover:bg-surface-50 dark:!hover:bg-surface-800">
        <!-- Data/Hora -->
        <td class="!font-mono !text-sm !text-surface-600 dark:!text-surface-400">
          {{ log.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}
        </td>

        <!-- Usuário -->
        <td>
          <div class="!flex !flex-col !gap-1">
            <div class="!font-medium !text-surface-900 dark:!text-surface-400">{{ log.email }}</div>
            <div class="!text-sm !text-surface-600 dark:!text-surface-400">{{ log.nome }}</div>
            <span class="badge !self-start" [ngClass]="{
                    'badge-admin': log.perfil === 'ADMIN',
                    'badge-user': log.perfil === 'user',
                    'badge-manager': log.perfil === 'manager'
                  }">
              {{ log.perfil }}
            </span>
          </div>
        </td>

        <!-- Método -->
        <td>
          <span class="badge" [ngClass]="{
                  'badge-method-get': log.method === 'GET',
                  'badge-method-post': log.method === 'POST',
                  'badge-method-put': log.method === 'PUT',
                  'badge-method-delete': log.method === 'DELETE',
                  'badge-method-patch': log.method === 'PATCH'
                }">
            {{ log.method }}
          </span>
        </td>

        <!-- Endpoint -->
        <td class="!font-mono !text-sm !text-surface-600 dark:!text-surface-400">
          {{ log.path }}
        </td>

        <!-- Status -->
        <td>
          <span class="badge" [ngClass]="{
                  'badge-status-success': log.statusCode >= 200 && log.statusCode < 300,
                  'badge-status-warning': (log.statusCode >= 300 && log.statusCode < 400) || (log.statusCode >= 400 && log.statusCode < 500),
                  'badge-status-error': log.statusCode >= 500
                }">{{ log.statusCode }}</span>
        </td>

        <!-- Sucesso -->
        <td>
          <span class="badge" [ngClass]="{
                  'badge-success-yes': log.success,
                  'badge-success-no': !log.success
                }">
            {{ log.success ? 'Sim' : 'Não' }}
          </span>
        </td>

        <!-- Tempo -->
        <td class="!font-mono !text-sm !text-surface-600 dark:!text-surface-400">
          {{ formatResponseTime(log.responseTime) }}
        </td>

        <!-- IP -->
        <td class="!font-mono !text-sm !text-surface-600 dark:!text-surface-400">
          {{ log.ip }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>